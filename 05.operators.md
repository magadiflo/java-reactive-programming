# Secci√≥n 5: Operadores

---

## Operador - Handle

El operador `handle()` en `Reactor` `es un operador de combinaci√≥n (composite)` que permite aplicar l√≥gica imperativa y
condicional en el procesamiento de elementos dentro de un `Flux`.

Combina las funcionalidades de:

- `filter()` ‚Üí para decidir si un elemento debe pasar o no.
- `map()` ‚Üí para transformar los elementos.

Se comporta como un `filtro m√°s una transformaci√≥n personalizada`, utilizando una funci√≥n
`BiConsumer<T, SynchronousSink<R>>` para procesar cada elemento.

Veamos un ejemplo sencillo donde usamos el `.handle()`. El ejemplo consiste en emitir un conjunto de n√∫meros desde el
1 hasta el 10. Seg√∫n el valor del item emitido realizar alguna acci√≥n, por ejemplo:

- Si se emite el 1, enviaremos el valor -2.
- Si se emite el 4, no haremos nada.
- Si se emite el 7, lanzaremos un error.
- En cualquier otro caso, pasaremos el valor como est√°.

````java
public class Lec01Handle {
    public static void main(String[] args) {
        Flux.range(1, 10)
                .handle((item, synchronousSink) -> {
                    switch (item) {
                        case 1 -> synchronousSink.next(-2);     // transforma 1 en -2
                        case 4 -> {
                        }                                       // no emite nada (se descarta)
                        case 7 -> synchronousSink.error(new RuntimeException("Lanzando error porque el valor es 7"));
                        default -> synchronousSink.next(item);  // pasa el valor tal como est√°
                    }
                })
                .cast(Integer.class)
                .subscribe(Util.subscriber());
    }
}
````

- El c√≥digo anterior recibe una funci√≥n handler con dos argumentos:
    - El valor de entrada (`item`).
    - Un `SynchronousSink` que permite:
        - Emitir un nuevo valor con `next(R value)`.
        - Terminar el flujo con `complete()`.
        - Emitir un error con `error(Throwable e)`.

- Si no se invoca `next()`, el elemento no se emite (similar a un `filter()` que descarta el elemento).
- `cast(Integer.class)` asegura que el tipo gen√©rico sea `Integer`.

Como resultado obtenemos lo siguiente.

````bash
11:33:40.646 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: -2
11:33:40.648 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: 2
11:33:40.648 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: 3
11:33:40.648 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: 5
11:33:40.648 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: 6
11:33:40.653 ERROR [           main] d.m.a.common.DefaultSubscriber :  error: Lanzando error porque el valor es 7
````

### üß† Cu√°ndo usar `handle()`

- Cuando necesitas `filtrar y transformar` al mismo tiempo.
- Si la l√≥gica de procesamiento requiere m√°s control que el que permite `map()` y `filter()` por separado.
- Para emitir errores condicionalmente o terminar el flujo antes de tiempo (`sink.error(...)`, `sink.complete()`).

## Operador Handle - Tarea asignada

Esta tarea nos permitir√° aplicar lo aprendido sobre el operador `handle()` y explorar su uso en conjunto con
`generate()`.

````java
public class Lec02HandleUntilAssignment {
    public static void main(String[] args) {
        Flux.<String>generate(synchronousSink -> synchronousSink.next(Util.faker().country().name()))
                .handle((country, synchronousSink) -> {
                    synchronousSink.next(country);
                    if (country.equalsIgnoreCase("peru")) {
                        synchronousSink.complete();
                    }
                }).subscribe(Util.subscriber());
    }
}
````

### ‚úÖ ¬øQu√© hace este c√≥digo?

1. Se genera un `Flux<String>` con `generate()`, que puede emitir nombres de pa√≠ses indefinidamente, dependiendo de la
   cantidad de elementos solicitados por el `Subscriber` (a trav√©s de `request(n)`).
2. Luego se pasa por el operador `handle()`:
    - Cada pa√≠s generado se emite directamente con `synchronousSink.next(country)`.
    - Si el pa√≠s es `Peru` (ignorando may√∫sculas/min√∫sculas), se llama a `synchronousSink.complete()`, lo que detiene la
      emisi√≥n del `Flux`.

### üîß Explicaci√≥n t√©cnica paso a paso

1. `generate(...)`
    - Es un operador para crear flujos imperativos, uno a la vez.
    - Usa un `SynchronousSink<T>` para emitir elementos `uno por uno`.
    - En este caso, el flujo puede emitir nombres de pa√≠ses indefinidamente mientras el `Subscriber` contin√∫e
      solicitando elementos.

2. `handle(...)`
    - Aqu√≠ funciona como un controlador condicional:
        - Siempre emite el pa√≠s recibido.
        - Pero si el pa√≠s es `Peru`, finaliza el flujo.

````bash
12:01:02.342 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: Seychelles
12:01:02.342 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: Central African Republic
12:01:02.342 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: Honduras
12:01:02.342 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: Lebanon
12:01:02.342 INFO  [           main] d.m.a.common.DefaultSubscriber :  recibido: Peru
12:01:02.344 INFO  [           main] d.m.a.common.DefaultSubscriber :  ¬°completado!
````

‚ö†Ô∏è La cantidad de pa√≠ses antes de `Peru` es aleatoria porque faker genera datos aleatorios.

