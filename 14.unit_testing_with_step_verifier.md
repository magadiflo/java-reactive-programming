# Sección 14: Unit Testing With Step Verifier

---

## Introducción

Las pruebas unitarias permiten verificar el comportamiento de pequeñas unidades de código (como métodos o funciones) de
forma aislada, asegurando que produzcan los resultados esperados.

En `programación reactiva` con `Reactor`, los publishers como `Mono` y `Flux` se comportan de forma asíncrona y
perezosa, por lo que su verificación requiere herramientas especializadas. Ahí es donde entra `StepVerifier`.

`StepVerifier` es una utilidad de pruebas provista por `Reactor` que permite simular suscripciones y verificar de
manera declarativa los eventos emitidos por un `Flux` o `Mono` (como `elementos`, `errores` o `finalización`).

Esto facilita escribir pruebas precisas, legibles y controladas para flujos reactivos.

## Unit Testing Mono

En este ejemplo se realiza una prueba unitaria sobre un `Mono` utilizando `StepVerifier`, que actúa como un suscriptor
simulado.

### ¿Qué es StepVerifier?

`StepVerifier` es una herramienta de pruebas incluida en Reactor que nos permite verificar el comportamiento de un
`Mono` o `Flux` paso a paso. Funciona como un `suscriptor controlado`, que `simula la suscripción al publisher` y
valida los eventos que este emite.

En este caso:

- `StepVerifier.create(...)`, prepara un verificador que se comportará como un suscriptor simulado. Pero aún no se ha
  suscrito al `publisher`. Es como preparar un plan de pruebas, pero no ejecutarlo.
- `.expectNext("product-1")`, indica que se espera ese valor como el siguiente emitido.
- `.expectComplete()`, indica que se espera que el flujo finalice correctamente (sin errores).
- `.verify()`, **es el momento en que realmente se activa la suscripción.** Antes de este punto, el `Mono` no ejecuta
  nada, debido a su naturaleza perezosa (`lazy`). Entonces, la suscripción real sucede cuando se llama al `.verify()`.
  Es en ese momento que el `Mono` comienza a ejecutarse.

````java
// StepVerifier actúa como un suscriptor
class Lec01MonoTest {
    private static final Logger log = LoggerFactory.getLogger(Lec01MonoTest.class);

    private Mono<String> getProduct(int id) {
        return Mono.fromSupplier(() -> "product-" + id)
                .doFirst(() -> log.info("invocado"));
    }

    @Test
    void productTest() {
        // given
        int id = 1;

        // when
        Mono<String> product = getProduct(id);

        // then
        StepVerifier.create(product)
                .expectNext("product-1")
                .expectComplete()
                .verify(); // Subscribe, aquí es donde se activa la suscripción
    }
}
````

Esto se confirma en el log:

````bash
11:13:56.176 INFO  [           main] d.magadiflo.app.Lec01MonoTest  : invocado
````

La línea `invocado` aparece solo cuando se llama a `.verify()`, lo que demuestra que es ahí cuando el `Mono` se ejecuta.
`StepVerifier` permite entonces probar flujos reactivos de forma precisa, declarativa y sincrónica dentro de pruebas
unitarias.

